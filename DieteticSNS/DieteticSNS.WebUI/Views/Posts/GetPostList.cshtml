@using DieteticSNS.Application.Models.Posts.Commands.UpdatePost;
@using DieteticSNS.Application.Models.Posts.Queries.GetPostsList

@using DieteticSNS.Application.Common.Extensions
@using DieteticSNS.Application.Common.Interfaces
@inject ICurrentUserService currentUserService

@{
    Layout = "~/Views/Shared/_StandardLayout.cshtml";

    UpdatePostCommand command = new UpdatePostCommand();
    PostListVm posts = (PostListVm)ViewBag.PostList;
    string dir = "~/img/uploads/";
}

<partial name="~/Views/Posts/_CreatePost.cshtml" />

@foreach (var item in posts.Posts)
{
    <div class="card my-4" id="@("postCard"+item.Id)">
        <div class="card-body pb-0">
            <div class="row mb-2">
                <div class="col-auto">
                    <img class="rounded-circle img-fluid border border-dark" style="height: 4rem; width: 4rem" src="@String.Concat(dir, item.AvatarPath)" asp-append-version="true" alt="Avatar">
                </div>
                <div class="col">
                    <h5 class="mb-3">@item.FirstName @item.LastName</h5>
                    <h6 class="card-title">@item.Title</h6>
                </div>
                <div class="col-auto">
                    <h6 class="text-muted">@item.CreatedAt.TimeAgo()</h6>
                </div>
                @if (item.UserId == int.Parse(currentUserService.GetUserId()))
                {
                    <div class="col-auto">
                        <div class="dropdown d-inline">
                            <a href="#" data-toggle="dropdown" style="color: inherit; text-decoration:none">
                                <i class="fas fa-ellipsis-h"></i>
                            </a>
                            <div class="dropdown-menu dropdown-menu-right">

                                <form id="@("editForm_"+item.Id)" asp-controller="Posts" asp-action="UpdatePost" asp-route-id="@item.Id" method="post">
                                    <button id="@("editButton_"+item.Id)" type="button" class="dropdown-item" data-toggle="modal" data-target="@("#editModal_"+item.Id)">Edit post <i class="far fa-edit"></i></button>
                                </form>

                                <div class="dropdown-divider"></div>

                                <form id="@("deleteForm_"+item.Id)" asp-controller="Posts" asp-action="DeletePost" asp-route-id="@item.Id" method="post" data-ajax="true" data-ajax-method="post" data-ajax-complete="hideModal(@item.Id)" data-ajax-success="setTimeout(deleteCard, 400, @item.Id)">
                                    <button type="button" class="dropdown-item" data-toggle="modal" data-target="@("#deleteModal_"+item.Id)">Delete post <i class="far fa-trash-alt"></i></button>
                                </form>

                            </div>

                            <div class="modal fade" id="@("deleteModal_"+item.Id)" tabindex="-1">
                                <div class="modal-dialog modal-sm modal-dialog-centered">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Delete confirmation</h5>
                                            <button type="button" class="close" style="outline: none" data-dismiss="modal"><span>&times;</span></button>
                                        </div>
                                        <div class="modal-body">
                                            Are you sure to delete this post?
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                            <button type="submit" class="btn btn-danger" form="@("deleteForm_"+item.Id)">Delete</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="modal fade" id="@("editModal_"+item.Id)" tabindex="-1">
                                <div class="modal-dialog modal-lg modal-dialog-centered">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Post edit</h5>
                                            <button type="button" class="close" style="outline: none" data-dismiss="modal"><span>&times;</span></button>
                                        </div>
                                        <div class="modal-body">
                                            @{
                                                command.Id = item.Id;
                                                command.Title = item.Title;
                                                command.Description = item.Description;
                                            }
                                            <input asp-for="@command.Id" form="@("editForm_"+item.Id)" hidden />
                                            <div class="form-group row">
                                                <div class="col-2 text-right">
                                                    <label asp-for="@command.Title" for="Title" class="col-form-label"><b>Title</b></label>
                                                </div>
                                                <div class="col-10">
                                                    <input asp-for="@command.Title" type="text" class="form-control" placeholder="Enter title" form="@("editForm_"+item.Id)">
                                                    <span asp-validation-for="@command.Title"></span>
                                                </div>
                                            </div>
                                            <div class="form-group row">
                                                <div class="col-2 text-right">
                                                    <label asp-for="@command.Description" for="description" class="col-form-label"><b>Description</b></label>
                                                </div>
                                                <div class="col-10">
                                                    <textarea asp-for="@command.Description" class="form-control" rows="3" placeholder="Say something here" form="@("editForm_"+item.Id)"></textarea>
                                                    <span asp-validation-for="@command.Description"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                            <button type="submit" class="btn btn-danger" form="@("editForm_"+item.Id)">Save</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                }
            </div>
            @if (!String.IsNullOrEmpty(item.Description))
            {
                <p class="card-text">
                    @item.Description
                </p>
            }
        </div>
        <div class="text-center">
            <img class="card-img-top p-4" src=@String.Concat(dir, item.PhotoPath) asp-append-version="true" alt="Post image">
        </div>
    </div>
}

@section LeftPanel
{
    <partial name="Layout/_UserProfile" />
}

@section Scripts
{
    <script src="~/js/changeFileLabelHtml.js"></script>
    <script src="~/js/deletePost.js"></script>
}
